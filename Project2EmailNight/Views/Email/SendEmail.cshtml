@model Project2EmailNight.Models.SendEmailPageViewModel

@{
    ViewData["Title"] = "SendEmail";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<body>
    <!-- wrapper -->
    <div class="wrapper">

        <div class="page-wrapper">
            <!--page-content-wrapper-->
            <div class="page-content-wrapper">
                <div class="page-content">
                    <!--start email wrapper-->
                    <div class="email-wrapper">
                        <div class="email-sidebar">
                            <div class="email-sidebar-header d-grid">
                                <a href="javascript:;" class="btn btn-primary compose-mail-btn"><i class='bx bx-plus me-2'></i>Yeni Mesaj</a>
                            </div>
                            <div class="email-sidebar-content">
                                <div class="email-navigation">
                                    <h6 class="text-uppercase fw-bold p-3 mb-0 font-12 text-muted">Klasörler</h6>
                                    <div class="list-group list-group-flush mb-3">
                                        <a href="/Email/SendEmail" class="list-group-item active d-flex align-items-center">
                                            <i class='bx bxs-inbox me-3 font-20'></i><span>Gelen Kutusu</span>
                                            <span class="badge bg-primary rounded-pill ms-auto">@ViewBag.InboxCount</span>
                                        </a>
                                        <a href="/Email/Starred" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-star me-3 font-20'></i><span>Yıldızlılar</span>
                                        </a>
                                        <a href="/Email/Sent" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-send me-3 font-20'></i><span>Gidenler</span>
                                        </a>
                                        <a href="/Email/Drafts" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-file-blank me-3 font-20'></i><span>Taslaklar</span>
                                            <span class="badge bg-warning text-dark rounded-pill ms-auto"> @ViewBag.DraftCount</span>
                                        </a>
                                        <a href="/Email/Trash" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-trash-alt me-3 font-20'></i><span>Silinenler</span>
                                        </a>
                                    </div>

                                    <h6 class="text-uppercase fw-bold p-3 mb-0 font-12 text-muted">Kategoriler</h6>
                                    <div class="list-group list-group-flush">
                                        <a href="/Category/WorkCategory" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-circle me-3 font-12 text-danger'></i><span>İş E-postaları</span>
                                        </a>
                                        <a href="/Category/EducationCategory" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-circle me-3 font-12 text-success'></i><span>Eğitim E-postaları</span>
                                        </a>
                                        <a href="/Category/FamilyCategory" class="list-group-item d-flex align-items-center">
                                            <i class='bx bxs-circle me-3 font-12 text-info'></i><span>Aile E-postaları</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="email-header d-xl-flex align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="email-toggle-btn">
                                    <i class='bx bx-menu'></i>
                                </div>
                                <div class="btn btn-white">
                                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                </div>
                                <div class="">
                                    <button type="button"
                                            class="btn btn-white ms-2"
                                            onclick="refreshInbox()">
                                        <i class='bx bx-refresh me-0'></i>
                                    </button>
                                </div>

                                <div class="d-none d-md-flex">
                                    <button type="button" class="btn btn-white ms-2">
                                        <i class='bx bx-file me-0'></i>
                                    </button>
                                </div>
                                <div class="">
                                    <button type="button"
                                            id="bulkDeleteBtn"
                                            class="btn btn-white ms-2">
                                        <i class='bx bx-trash me-0'></i>
                                    </button>
                                </div>

                            </div>
                            <div class="flex-grow-1 mx-xl-2 my-2 my-xl-0">
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent"><i class="bx bx-search"></i></span>
                                    <input type="text" class="form-control" placeholder="Ara">
                                </div>
                            </div>
                            <div class="ms-auto d-flex align-items-center">
                                <button class="btn btn-sm btn-light">1-50 / 8,740</button>
                                <button class="btn btn-white px-2 ms-2">
                                    <i class='bx bx-chevron-left me-0'></i>
                                </button>
                                <button class="btn btn-white px-2 ms-2">
                                    <i class='bx bx-chevron-right me-0'></i>
                                </button>
                            </div>
                        </div>
                        <div class="email-content">
                            <div class="">
                                <div class="email-list">
                                    <div class="d-md-flex align-items-center px-3 py-2 bg-white border-bottom fw-semibold text-secondary small shadow-sm">

                                        <div style="width: 250px;">
                                            <i class='bx bx-user me-1'></i> Gönderen
                                        </div>

                                        <div class="flex-grow-1">
                                            <i class='bx bx-envelope me-1'></i> Konu & Mesaj
                                        </div>

                                        <div style="width: 100px;" class="text-end">
                                            <i class='bx bx-time me-1'></i> Tarih
                                        </div>

                                    </div>


                                    @foreach (var item in Model.InboxMessages)
                                    {
                                        var unread = !item.IsStatus;

                                    <a asp-controller="Email"
                                       asp-action="MessageDetails"
                                       asp-route-id="@item.MessageId"
                                       class="text-decoration-none text-dark">


                                        <div class="d-flex align-items-center px-4 py-3 border-bottom email-row @(unread ? "unread-row" : "")">
                                            <!-- CHECKBOX -->
                                            <div class="me-3">
                                                <input type="checkbox"
                                                       class="form-check-input message-checkbox"
                                                       value="@item.MessageId"
                                                       onclick="event.stopPropagation();">
                                            </div>
                                            <!-- STAR -->
                                            <div class="me-3">
                                                <i class='bx @(item.IsStarred ? "bxs-star text-warning" : "bx-star text-secondary") star-icon'
                                                   onclick="toggleStar(event, @item.MessageId)"
                                                   style="font-size:18px; cursor:pointer;"></i>
                                            </div>
                                            <!-- Avatar -->
                                            <div class="me-3">
                                                <div class="avatar-circle">
                                                    @item.SenderEmail.Substring(0, 1).ToUpper()
                                                </div>
                                            </div>

                                            <!-- Sender -->
                                            <div style="width:200px;" class="@(unread ? "fw-bold" : "")">
                                                @item.SenderEmail
                                            </div>

                                            <!-- Subject + Preview -->
                                            <div class="flex-grow-1 text-truncate @(unread ? "fw-semibold" : "text-muted")">
                                                @item.Subject -
                                                @Html.Raw(item.MessageDetail.Length > 60
                                                                                                ? item.MessageDetail.Substring(0, 60) + "..."
                                                                                                : item.MessageDetail)
                                            </div>

                                            <!-- Date -->
                                            <div style="width:120px;"
                                                 class="text-end small @(unread ? "fw-bold text-dark" : "text-muted")">
                                                @item.SendDate.ToString("dd MMM")
                                            </div>

                                            <i class='bx bx-trash text-danger'
                                               onclick="deleteMessage(event, @item.MessageId)"
                                               style="cursor:pointer;"></i>


                                        </div>
                                    </a>
                                                                        }

                                </div>
                            </div>
                        </div>
                        <!--start compose mail-->
                        <div class="compose-mail-popup">
                            <div class="card">
                                <div class="card-header bg-dark text-white py-2 cursor-pointer">
                                    <div class="d-flex align-items-center">
                                        <div class="compose-mail-title">Yeni Mesaj</div>
                                        <div class="compose-mail-close ms-auto">x</div>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <form method="post" asp-action="SendEmail" asp-controller="Email">

                                        <div class="mb-3">
                                            <input type="text" class="form-control"
                                                   asp-for="MailRequest.ReceiverEmail"
                                                   placeholder="Kime" />
                                        </div>

                                        <div class="mb-3">
                                            <input type="text" class="form-control"
                                                   asp-for="MailRequest.Subject"
                                                   placeholder="Konu" />

                                        </div>

                                        <div class="mb-3">
                                            <div id="editor" style="height: 250px;"></div>

                                            <input type="hidden" asp-for="MailRequest.MessageDetail" id="MessageDetail" />



                                        </div>

                                        <div class="text-end">

                                            <button type="submit" name="actionType" value="draft"
                                                    class="btn btn-secondary me-2">
                                                Taslak Kaydet
                                            </button>

                                            <button type="submit" name="actionType" value="send"
                                                    class="btn btn-primary">
                                                Gönder
                                            </button>

                                        </div>

                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="ms-auto">
                            <button type="button" class="btn border-0 btn-sm btn-white">
                                <i class="lni lni-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!--end compose mail-->
    <!--start email overlay-->
    <div class="overlay email-toggle-btn-mobile"></div>
    <!--end email overlay-->
    </div>
    <!--end email wrapper-->
    </div>
    </div>
    <!--end page-content-wrapper-->
    </div>
    <!--end page-wrapper-->
    <!--start overlay-->
    <div class="overlay toggle-btn-mobile"></div>
    <!--end overlay-->
    <!--Start Back To Top Button-->
    <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>
    <!--End Back To Top Button-->
    <!--footer -->
    <div class="footer">
        <p class="mb-0">
            Syndash @DateTime.Now | Developed By : <a href="https://themeforest.net/user/codervent" target="_blank">codervent</a>
        </p>
    </div>
    <!-- end footer -->
    </div>

    <script>
        new PerfectScrollbar('.email-navigation');
        new PerfectScrollbar('.email-list');
    </script>


    <!-- App JS -->
    <script src="~/vertical-20260127T171413Z-3-001/vertical/assets/js/app.js"></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        // Form submit edilirken HTML'i hidden input'a aktar
        document.querySelector('form').onsubmit = function () {
            document.querySelector('#MessageDetail').value =
                quill.root.innerHTML;
        };
    </script>
    <script>
        function toggleStar(event, messageId) {
            event.preventDefault();
            event.stopPropagation();

            fetch('/Email/ToggleStar/' + messageId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {

                const icon = event.target;

                if (data.isStarred) {
                    icon.classList.remove('bx-star', 'text-secondary');
                    icon.classList.add('bxs-star', 'text-warning');
                } else {
                    icon.classList.remove('bxs-star', 'text-warning');
                    icon.classList.add('bx-star', 'text-secondary');
                }
            });
        }
    </script>
    <script>
        function deleteMessage(event, messageId) {
            event.preventDefault();
            event.stopPropagation();

            fetch('/Email/Delete/' + messageId, {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    </script>

    <script>
        const selectAll = document.getElementById("selectAllCheckbox");
        const checkboxes = document.querySelectorAll(".message-checkbox");

        selectAll.addEventListener("change", function () {
            checkboxes.forEach(function (checkbox) {
                checkbox.checked = selectAll.checked;
            });
        });

        checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener("change", function () {
                const allChecked = [...checkboxes].every(c => c.checked);
                selectAll.checked = allChecked;
            });
        });
    </script>

    <script>
        function refreshInbox() {
            const icon = document.querySelector('.bx-refresh');

            icon.classList.add("bx-spin");

            setTimeout(() => {
                location.reload();
            }, 500);
        }
    </script>

    <script>
        document.getElementById("bulkDeleteBtn")
            .addEventListener("click", function () {

            const selectedIds = [];

            document.querySelectorAll(".message-checkbox:checked")
                .forEach(cb => {
                    selectedIds.push(parseInt(cb.value));
                });

            if (selectedIds.length === 0) {
                alert("Lütfen silmek için mesaj seçin.");
                return;
            }

            fetch('/Email/BulkDelete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(selectedIds)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });
    </script>


    <style>
        .email-row {
            transition: all 0.2s ease;
            background-color: #fff;
        }

            .email-row:hover {
                background-color: #f5f7fb;
                transform: scale(1.005);
            }

        .unread-row {
            background-color: #f0f6ff;
        }

        .avatar-circle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4e73df, #1cc88a);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
    </style>

</body>



@*  <div class="container">
    <br /><br />
    <form method="post">
        <label>Alıcı Email</label>
        <input type="text" asp-for="ReceiverEmail" class="form-control">
        <br />
        <label>Konu</label>
        <input type="text" asp-for="Subject" class="form-control" />
        <br />
        <label>Mesaj</label>
        <input type="text" asp-for="MessageDetail" class="form-control" />
        <br />
        <button class="btn btn-info">Mail Gönder</button>
    </form>
</div> *@
